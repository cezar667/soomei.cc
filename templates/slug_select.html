{% extends "base.html" %}
{% block title %}Escolher slug{% endblock %}
{% block content %}
  <h1>Escolher seu slug</h1>
  <p>Este sera o seu endereco publico: <code>/slug</code></p>
  <form method="post" action="/slug/select/{{ uid }}">
    <label>Slug</label>
    <div class="slug-input-row">
      <input name="value" id="slug" value="{{ current }}" placeholder="seu-nome" pattern="[a-z0-9-]{3,30}" required aria-describedby="slugInfoTip">
      <button type="button" class="icon-btn icon-sm" id="slugInfoBtn" aria-label="O que é um slug?" title="O que é um slug?">i</button>
      <div id="slugInfoTip" class="info-tip" role="tooltip" aria-hidden="true">
        Slug é o endereço curto que aparece na URL pública do seu cartão.
        Use 3–30 caracteres minúsculos, números ou hífen. Ex.: seu-nome
      </div>
    </div>
    <div id="msg" class="hint"></div>
    <button class="btn">Salvar slug</button>
  </form>
{% endblock %}

{% block scripts %}
  <script>
    (function(){
      // Styles (scoped) for feedback
      var style = document.createElement('style');
      style.textContent = '.hint{font-size:12px;margin:4px 0 0}.ok{color:#7bd88f}.bad{color:#f88}#slug.is-ok{border-color:#43a047;background:rgba(67,160,71,.09)}#slug.is-bad{border-color:#e53935;background:rgba(229,57,53,.08)} .tooltip-err{display:inline-block;background:#2a2211;border:1px solid #4d3b12;color:#e5c17a;padding:6px 8px;border-radius:8px;margin-top:4px} .slug-input-row{position:relative;display:flex;align-items:center;gap:8px} .icon-btn.icon-sm{width:26px;height:26px;font-size:14px} .info-tip{position:absolute;right:0;top:100%;margin-top:6px;display:none;max-width:320px;background:#111114;border:1px solid #242427;border-radius:8px;padding:8px 10px;color:#eaeaea;box-shadow:0 2px 8px rgba(0,0,0,.45);z-index:1000} .info-tip.show{display:block}';
      document.head.appendChild(style);

      const el = document.getElementById('slug');
      const msg = document.getElementById('msg');
      if (!el || !msg) return;
      let t;
      let lastOk = false;
      async function check(v){
        v = (v||'').trim().toLowerCase();
        if (!v){ msg.textContent=''; el.classList.remove('is-ok','is-bad'); return; }
        try{
          const r = await fetch('/slug/check?value='+encodeURIComponent(v));
          const j = await r.json();
          if (j && j.available){
            msg.innerHTML = '<span class="ok">Disponivel</span>';
            el.classList.add('is-ok'); el.classList.remove('is-bad');
            lastOk = true;
          } else {
            msg.innerHTML = '<span class="bad">Indisponivel</span>';
            el.classList.add('is-bad'); el.classList.remove('is-ok');
            lastOk = false;
          }
        } catch(_e){
          // On error, clear feedback to avoid stale state
          el.classList.remove('is-ok','is-bad'); msg.textContent='';
          lastOk = false;
        }
      }
      el.addEventListener('input', function(){
        // force lowercase on typing
        const vv = el.value||''; const ll = vv.toLowerCase(); if (vv!==ll) el.value = ll;
        clearTimeout(t); t=setTimeout(function(){ check(el.value); }, 220);
      });
      // prevent submission when unavailable; show tooltip message
      const form = el.closest('form');
      if (form){
        form.addEventListener('submit', function(e){
          const ok = el.classList.contains('is-ok');
          if (!ok){
            try{ e.preventDefault(); e.stopPropagation(); }catch(_e){}
            msg.innerHTML = '<span class="bad tooltip-err">Slug indisponivel, tente outro.</span>';
            el.classList.add('is-bad'); el.classList.remove('is-ok');
            try{ el.focus(); }catch(_e){}
          }
        });
      }
      // initial check
      check(el.value);

      // Info tooltip logic
      const infoBtn = document.getElementById('slugInfoBtn');
      const infoTip = document.getElementById('slugInfoTip');
      if (infoBtn && infoTip){
        infoBtn.addEventListener('click', function(e){
          e.preventDefault(); e.stopPropagation();
          infoTip.classList.toggle('show');
          infoTip.setAttribute('aria-hidden', infoTip.classList.contains('show') ? 'false' : 'true');
        });
        document.addEventListener('click', function(){
          infoTip.classList.remove('show');
          infoTip.setAttribute('aria-hidden','true');
        });
        infoTip.addEventListener('click', function(e){ e.stopPropagation(); });
      }
    })();
  </script>
{% endblock %}
